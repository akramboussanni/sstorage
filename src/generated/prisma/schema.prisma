generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  output          = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model User {
  id                    String        @id @default(uuid())
  username              String        @unique
  password              String
  isAdmin               Boolean       @default(false)
  mustChangePassword    Boolean       @default(false)
  createdAt             DateTime      @default(now())
  media                 Media[]
  ownedDrives           Drive[]       @relation("OwnedDrives")
  driveAccess           DriveAccess[]
  customMaxFileSize     BigInt? // Custom limit in bytes, overrides global setting
  customRateLimitWindow Int? // Custom cooldown in seconds
}

model Media {
  id              String   @id @default(uuid())
  filename        String
  originalName    String
  mimeType        String
  size            Int
  ip              String?
  userId          String?
  user            User?    @relation(fields: [userId], references: [id])
  transcodeStatus String   @default("not_required") // pending, processing, completed, failed, not_required
  transcodeError  String?
  createdAt       DateTime @default(now())
  driveId         String?
  drive           Drive?   @relation(fields: [driveId], references: [id], onDelete: Cascade)
  folderId        String?
  folder          Folder?  @relation(fields: [folderId], references: [id], onDelete: Cascade)
  isPinned        Boolean  @default(false)
  orderIndex      Int      @default(0)
}

model Folder {
  id         String   @id @default(uuid())
  name       String
  driveId    String
  drive      Drive    @relation(fields: [driveId], references: [id], onDelete: Cascade)
  parentId   String?
  parent     Folder?  @relation("SubFolders", fields: [parentId], references: [id], onDelete: Cascade)
  subFolders Folder[] @relation("SubFolders")
  files      Media[]
  userId     String
  color      String?  @default("hsl(210, 100%, 50%)") // Default blue
  isPinned   Boolean  @default(false)
  orderIndex Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Drive {
  id          String  @id @default(uuid())
  name        String
  description String?
  ownerId     String
  owner       User    @relation("OwnedDrives", fields: [ownerId], references: [id])

  // Public Access Settings
  isPublic   Boolean @default(false)
  publicRole String  @default("VIEWER") // VIEWER, EDITOR (Upload/Delete)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  files   Media[]
  folders Folder[]
  access  DriveAccess[]
}

model DriveAccess {
  id      String @id @default(uuid())
  driveId String
  drive   Drive  @relation(fields: [driveId], references: [id], onDelete: Cascade)
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    String @default("VIEWER") // VIEWER, EDITOR

  createdAt DateTime @default(now())

  @@unique([driveId, userId])
}

model Settings {
  id                 String  @id @default("default")
  allowPublicUpload  Boolean @default(false)
  allowRegistration  Boolean @default(false)
  maxFileSize        BigInt  @default(104857600) // 100MB in bytes
  rateLimitWindow    Int     @default(10) // Cooldown in seconds
  defaultCompression String  @default("balanced") // none, high, balanced, small
  showNoCompression  Boolean @default(true)
  smtpHost           String?
  smtpPort           Int?
  smtpUser           String?
  smtpPassword       String?
  smtpFrom           String?
}
